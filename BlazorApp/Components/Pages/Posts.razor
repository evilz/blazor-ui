@page "/posts"
@rendermode InteractiveServer
@using BlazorApp.Models
@using BlazorApp.Services
@inject IJsonPlaceholderService JsonPlaceholderService
@inject NavigationManager Navigation

<PageTitle>Blog - Blazor UI</PageTitle>

<div class="mx-auto max-w-4xl p-4 md:p-6">
    <!-- Header -->
    <div class="mb-6 flex flex-col justify-between gap-4 sm:flex-row sm:items-center md:mb-8">
        <div>
            <Breadcrumb Items="@breadcrumbItems" />
            <h1 class="text-foreground text-xl font-semibold md:text-2xl">Blog Posts</h1>
        </div>
        <div class="flex items-center gap-3 md:gap-4">
            <Button Icon="filter_list" Type="ButtonType.Ghost" Size="ButtonSize.Small" Tooltip="Filter posts" />
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading">Loading posts...</div>
    }
    else if (posts.Count == 0)
    {
        <Card>
            <CardContent>
                <p>No posts found.</p>
            </CardContent>
        </Card>
    }
    else
    {
        <!-- Activity Timeline -->
        <div class="space-y-4 md:space-y-6">
            @{
                string currentDate = "";
            }
            @foreach (var post in posts.Take(20))
            {
                var postDate = GetPostDate(post.Id);
                var showDate = currentDate != postDate;
                if (showDate)
                {
                    currentDate = postDate;
                }

                <div key="@post.Id">
                    @if (showDate)
                    {
                        <!-- Date Header -->
                        <div class="text-muted-foreground mb-3 text-xs font-medium tracking-wide uppercase md:mb-4 md:text-sm">
                            @postDate
                        </div>
                    }

                    <!-- Post Item -->
                    <div class="relative flex gap-2 md:gap-3 cursor-pointer hover:bg-muted rounded-lg p-2 transition-colors" @onclick="() => NavigateToPost(post.Id)">
                        <!-- Timeline Line -->
                        @if (post.Id != posts.Take(20).Last().Id)
                        {
                            <div class="bg-border absolute top-10 bottom-0 left-3 w-px md:top-12 md:left-4"></div>
                        }

                        <!-- Avatar -->
                        <div class="relative z-10">
                            <Avatar Name="@GetUserInitials(post.UserId)" />
                        </div>

                        <!-- Content -->
                        <div class="min-w-0 flex-1">
                            <div class="flex flex-col gap-1 text-xs sm:flex-row sm:items-center sm:gap-2 md:text-sm">
                                <div class="flex flex-wrap items-center gap-1 sm:gap-2">
                                    <span class="text-foreground font-medium">User @post.UserId</span>
                                    <span class="text-muted-foreground">posted</span>
                                    <span class="text-foreground font-medium capitalize">@TruncateTitle(post.Title)</span>
                                </div>
                                <span class="text-muted-foreground text-xs sm:ml-auto md:text-sm">
                                    @GetPostTime(post.Id)
                                </span>
                            </div>

                            <!-- Post Body -->
                            <div class="bg-muted text-muted-foreground mt-2 rounded-lg p-2 text-xs leading-relaxed md:mt-3 md:p-3 md:text-sm">
                                <h3 class="text-foreground font-semibold mb-2 capitalize">@post.Title</h3>
                                @post.Body
                            </div>

                            <!-- Post Badge -->
                            <div class="mt-2 flex flex-wrap gap-2 items-center">
                                <Badge Text="@($"Post #{post.Id}")" Type="BadgeType.Outline" />
                                <span class="text-muted-foreground text-xs">Click to view comments</span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Post> posts = new();
    private bool isLoading = true;
    private List<Sysinfocus.AspNetCore.Components.Breadcrumb.BreadcrumbModel> breadcrumbItems = new();

    protected override void OnInitialized()
    {
        breadcrumbItems = new List<Sysinfocus.AspNetCore.Components.Breadcrumb.BreadcrumbModel>
        {
            new Sysinfocus.AspNetCore.Components.Breadcrumb.BreadcrumbModel("Home") { Url = "/" },
            new Sysinfocus.AspNetCore.Components.Breadcrumb.BreadcrumbModel("Blog") { Url = "/posts" }
        };
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            posts = await JsonPlaceholderService.GetPostsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading posts: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToPost(int postId)
    {
        Navigation.NavigateTo($"/posts/{postId}");
    }

    private string GetUserInitials(int userId)
    {
        return $"U{userId}";
    }

    private string TruncateTitle(string title)
    {
        if (title.Length > 50)
        {
            return title.Substring(0, 50) + "...";
        }
        return title;
    }

    private string GetPostDate(int postId)
    {
        // Simulate different dates based on post ID for demo purposes
        var baseDate = DateTime.Now;
        var daysAgo = (postId - 1) / 3; // Group posts by date
        var date = baseDate.AddDays(-daysAgo);
        return date.ToString("dddd, dd MMMM").ToUpper();
    }

    private string GetPostTime(int postId)
    {
        // Simulate different times based on post ID
        var baseTime = DateTime.Now;
        var hoursAgo = (postId - 1) % 12;
        var time = baseTime.AddHours(-hoursAgo);
        return time.ToString("hh:mm tt");
    }
}

<style>
    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--muted-foreground, #64748b);
    }

    .text-foreground {
        color: var(--foreground, #1e293b);
    }

    .text-muted-foreground {
        color: var(--muted-foreground, #64748b);
    }

    .bg-muted {
        background-color: var(--muted, #f1f5f9);
    }

    .bg-border {
        background-color: var(--border, #e2e8f0);
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .hover\:bg-muted:hover {
        background-color: var(--muted, #f1f5f9);
    }

    .transition-colors {
        transition: background-color 0.2s ease;
    }

    .capitalize {
        text-transform: capitalize;
    }

    .uppercase {
        text-transform: uppercase;
    }
</style>
